# PromptSE 剩余功能实现方案

## 待完成功能清单

根据当前TODO列表，还需要完成以下功能：

### 1. 词库导入和搜索功能 (优先级: 高)
### 2. 拖拽排序功能 (优先级: 中)  
### 3. 设置面板 (优先级: 中)
### 4. 测试和完善功能 (优先级: 低)

---

## 详细实现方案

### 1. 词库导入和搜索功能

#### 功能描述
- 支持导入 `.txt` 格式的词库文件
- 实时搜索词库内容(支持中英文)
- 点击词条直接插入到当前编辑的条目中
- 支持创建新的词库条目

#### 技术架构

**数据结构:**
```javascript
{
  lexicon: [
    {
      id: "uuid",
      english: "beautiful girl",
      chinese: "美丽女孩", 
      category: "character",
      tags: ["beauty", "girl", "人物"],
      weight: 1.0
    }
  ]
}
```

**组件设计:**
```
┌─ 词库面板 (LexiconPanel) ─────────────────┐
│ ┌─ 导入按钮 ─┐ ┌─ 搜索框 ──────────────┐ │
│ │ 📁 Import │ │ 🔍 Search tags...    │ │
│ └──────────┘ └─────────────────────┘ │
│ ┌─ 词条列表 ─────────────────────────┐ │
│ │ [character] beautiful girl 美丽女孩  │ │
│ │ [style] anime style 动漫风格        │ │
│ │ [quality] high quality 高质量       │ │
│ └─────────────────────────────────┘ │
│ ┌─ 创建新词条 ────────────────────────┐ │
│ │ EN: [ input ] CN: [ input ] [Add] │ │
│ └─────────────────────────────────┘ │
└────────────────────────────────────┘
```

**实现步骤:**
1. 在工具栏添加"导入词库"按钮
2. 实现文件选择和解析逻辑 (支持CSV/TXT格式)
3. 在模态编辑器中添加词库搜索面板
4. 实现实时搜索和标签点击插入
5. 添加新词条创建功能

**文件解析格式:**
```
beautiful girl,美丽女孩
anime style,动漫风格
high quality,高质量
```

---

### 2. 拖拽排序功能

#### 功能描述
- 通过拖拽手柄重新排列条目顺序
- 流畅的拖拽动画效果
- 支持键盘辅助操作

#### 技术架构

**拖拽实现方案:**
```javascript
// 使用原生HTML5 Drag & Drop API
class DragDropManager {
  constructor(entriesList, updateCallback) {
    this.entriesList = entriesList;
    this.updateCallback = updateCallback;
    this.draggedElement = null;
    this.draggedIndex = -1;
  }
  
  enableDragDrop() {
    // 为每个条目添加拖拽功能
  }
  
  handleDragStart(e, index) { /* 开始拖拽 */ }
  handleDragOver(e) { /* 拖拽悬停 */ }
  handleDrop(e, targetIndex) { /* 放置完成 */ }
}
```

**UI设计:**
```
┌─ Entry Card ─────────────────────┐
│ ☑ [≡] Title        [±] Weight [✕] │  ← [≡] 为拖拽手柄
│ Content preview...               │
└─────────────────────────────────┘
```

**实现步骤:**
1. 为每个条目添加拖拽手柄 `[≡]`
2. 实现HTML5 Drag & Drop事件处理
3. 添加拖拽时的视觉反馈效果
4. 更新数据数组顺序并重新渲染
5. 添加拖拽动画和边界检查

---

### 3. 设置面板

#### 功能描述
- 全局连接符配置
- 权重格式选择
- 主题和样式设置
- 导入/导出配置

#### 技术架构

**设置数据结构:**
```javascript
{
  settings: {
    connector: ", ",           // 连接符: ", ", "\n", " | "
    weightFormat: "parentheses", // 权重格式: parentheses, brackets, none
    theme: "dark",            // 主题: dark, light
    autoSave: true,          // 自动保存
    showPreview: true,       // 显示输出预览
    compactMode: false       // 紧凑模式
  }
}
```

**设置面板设计:**
```
┌─ Settings Panel ─────────────────────────┐
│ ┌─ General ─────────────────────────────┐ │
│ │ Connector: [, ] [换行] [|] [自定义]    │ │
│ │ Weight Format: (parentheses) brackets  │ │
│ │ Theme: ● Dark ○ Light                 │ │
│ └─────────────────────────────────────┘ │
│ ┌─ Advanced ────────────────────────────┐ │
│ │ ☑ Auto Save                          │ │
│ │ ☑ Show Output Preview               │ │
│ │ ☐ Compact Mode                      │ │
│ └─────────────────────────────────────┘ │
│ ┌─ Data Management ─────────────────────┐ │
│ │ [Export Config] [Import Config]      │ │
│ │ [Export Lexicon] [Reset to Default]  │ │
│ └─────────────────────────────────────┘ │
│ [Cancel] [Apply] [Save]                 │
└─────────────────────────────────────────┘
```

**实现步骤:**
1. 在工具栏添加设置按钮 `⚙️`
2. 创建可拖拽的设置模态窗口
3. 实现各种设置选项的UI控件
4. 添加设置预览和实时应用功能
5. 实现配置导入/导出功能

---

### 4. 测试和完善功能

#### 测试计划
- **单元测试**: 核心数据处理逻辑
- **集成测试**: 前后端数据同步
- **用户体验测试**: 拖拽、搜索、编辑流程
- **兼容性测试**: 不同ComfyUI版本适配

#### 完善内容
- **错误处理**: 文件解析失败、数据损坏恢复
- **性能优化**: 大量词库的搜索优化
- **用户反馈**: 操作成功/失败的视觉提示
- **文档完善**: 更新README和使用说明

---

## 实现优先级和时间估算

### 阶段1: 词库功能 (2-3小时)
- [x] 基础导入功能
- [x] 搜索和过滤
- [x] 模态编辑器集成
- [x] 新词条创建

### 阶段2: 拖拽排序 (1-2小时)  
- [x] HTML5 Drag & Drop实现
- [x] 拖拽手柄和视觉效果
- [x] 数据同步和持久化

### 阶段3: 设置面板 (1-2小时)
- [x] 设置UI设计和实现
- [x] 配置选项和预览
- [x] 导入导出功能

### 阶段4: 测试完善 (1小时)
- [x] 错误处理和边界情况
- [x] 性能优化
- [x] 用户体验细节

**总预计时间: 5-8小时**

---

## 技术风险和解决方案

### 风险1: 文件导入兼容性
**解决方案:** 支持多种编码格式(UTF-8, GBK)，添加格式检测

### 风险2: 拖拽性能问题
**解决方案:** 使用虚拟滚动，限制同时显示的条目数量

### 风险3: 数据持久化复杂度
**解决方案:** 设计向后兼容的数据格式，添加版本迁移逻辑

---

## 最终效果预览

完成后的PromptSE节点将具备：
- ✅ 现代化扁平设计UI
- ✅ 完整的权重调整系统  
- ✅ 可拖动的模态编辑器
- ✅ 自适应布局和尺寸限制
- ✅ 正确的S/M模式逻辑
- 🔄 丰富的词库管理功能
- 🔄 直观的拖拽排序体验
- 🔄 灵活的设置和配置选项
- 🔄 完善的错误处理和用户反馈

这将是一个功能完整、用户体验出色的专业级提示词管理工具。